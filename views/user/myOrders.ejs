<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/stylesheets/dashboardHeader.css">
    <link rel="stylesheet" href="/stylesheets/ordertracking.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script> -->
    <style>
        * {
            box-sizing: border-box;
        }

        .container {
            padding-top: 10px;
            display: flex;
            flex-direction: column;
            /* justify-content: center; */
            align-items: center;
        }

        .orderItem {
            width: 80%;
            height: 200px;
            border-radius: 10px;
            display: flex;
            justify-content: flex-start;
            box-shadow: 1px 1px 4px grey;
            margin: 10px;
        }

        .p_image {
            border-radius: 10px 0px 0px 10px;
            width: 20%;
        }

        .order_details {
            height: 100%;
            width: 50%;
            display: flex;
            flex-direction: column;
            padding: 10px;
            align-items: center;
        }

        .shipping_address {
            width: 100%;
            height: 20%;
        }

        .payment_status,
        .bill,
        .quantity,
        .product_id {
            padding: 2px;
            height: 20%;
            width: 100%;
        }

        .actions {
            height: 100%;
            width: 30%;
            border-radius: 0px 10px 10px 0px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
        }

        .order_id {
            width: 100%;
            word-wrap: break-word;
            padding: 10px;
        }

        .action_btn {
            align-self: flex-end;
            background-color: green;
            color: white;
            font-size: 15px;
            font-weight: 600;
            padding: 8px 13px;
            border: none;
            border-radius: 10px;
            margin-bottom: 20px;
            margin-right: 20px;
        }

        .form {
            position: fixed;
            top: 150px;
            height: 350px;
            width: 900px;
            box-shadow: 1px 1px 4px black;
            justify-self: flex-start;
            z-index: 10;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .trackingStatusPopUp {
            position: relative;
            padding-top: 30px;
        }

        .track-circle-div {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background-color: green;
            display: inline;
        }

        .confirmed,
        .dispatched,
        .delivered,
        .waiting,
        .cancelled {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 3px solid green;
            display: inline;
        }

        .confirmed {
            border: none;
            background-color: blue;
        }

        .dispatched {
            border: none;
            background-color: yellow;
        }

        .cancelled {
            border: none;
            background-color: red;
        }

        .delivered {
            border: none;
            background-color: green;
        }
    </style>
</head>

<body>
    <%- include('components/header') %>
        <div class="container" id="trackingStatus"
            style="display:none; height:100vh; background-color:rgba(0, 0, 0, 0.274); width: 100%; position: fixed;">
            <div class="form trackingStatusPopUp" id="trackingStatusPopUp">
                <h2 onclick="closeTrackingWindow()" style="position: absolute; top: 5px; right: 10px;">&times;</h2>
                <div class="progress-bar">
                    <div class="step active" id="step-1">
                        <i class="fas fa-check"></i>
                        Order Confirmed
                    </div>
                    <div class="step active" id="step-2">
                        <i class="fas fa-truck"></i>
                        Dispatched
                    </div>
                    <div class="step active" id="step-3">
                        <i class="fas fa-warehouse"></i>
                        Arrived at Warehouse
                    </div>
                    <div class="step active" id="step-4">
                        <i class="fas fa-road"></i>
                        Out for Delivery
                    </div>
                    <div class="step " id="step-5">
                        <i class="fas fa-check-circle"></i>
                        Delivered
                    </div>
                </div>     
            </div>
        </div>
        <div class="container" id="reason"
            style="display:none; height:100vh; background-color:rgba(0, 0, 0, 0.274); width: 100%; position: fixed;">
            <div class="form">
                <label for="" style="margin-bottom: 10px;">Tell us why are you cancelling:</label>
                <textarea name="reason" id="reasontext" cols="30" rows="10"></textarea>
                <p style="color: red;" id="reason_err"></p>
                <button id="cancelBtn" class="action_btn" style="margin: 20px; align-self: center;">Cancel
                    Order</button>
            </div>
        </div>
        <div class="container" id="orders">
            <% if(orders.length>0){ %>
                <% orders.forEach(element=> { %>
                    <div class="orderItem" id="orderItem-<%= element.order_id %>">
                        <img src="<%= !element.image.includes(".")?"/"+element.image:element.image %>" alt=""
                        class="p_image">
                        <div class="order_details">
                            <div class="product_id">Product Name: <%= element.name %>
                            </div>
                            <div class="shipping_address">Shipping Address: <%= element.shipping_address %>
                            </div>
                            <div class="payment_status">Payment mode: <%= element.payment_mode %>
                            </div>
                            <div class="bill">Total Bill: <%= element.bill %> $</div>
                            <div class="quantity">Quantity: <%= element.order_quantity %>
                            </div>
                            <div class="quantity">Payment Status: <%= element.payment_status %>
                            </div>
                        </div>
                        <div class="actions">
                            <div class="order_id">
                                <p>OrderId:</p>
                                <p>
                                    <%= element.order_id %>
                                </p>
                                <br>
                                <div style="display: flex; align-items: center; ">
                                    <% if(element.status=="waiting" ){ %>
                                        <button class="waiting"></button>
                                    <% } else if(element.status=="confirmed" ) {%>
                                        <button class="confirmed"></button>
                                    <% } else if(element.status=="dispatched" ){ %>
                                        <button class="dispatched"></button>
                                    <% } else if(element.status=="delivered" ){ %>
                                        <button class="delivered"></button>
                                    <% } else { %>
                                        <button class="cancelled"></button>
                                    <% } %>
                                    <p id="ord-sts-<%= element.order_id %>"style="margin-left: 10px;"> <span id="ps-<%= element.order_id %>"><%= element.status %></span></p>
                                </div>
                                <br>
                                <% if(element.status=="delivered" ) { %>
                                    <p>Delivered on: <%= new Date(element.delivery_date).toLocaleDateString() %></p>
                                <% } else if (element.status!="cancelled" ) { %>
                                    <p id="exp-del-<%= element.order_id %>">Expected Delivery: <%= new Date(element.delivery_date).toLocaleDateString() %></p>
                                <% } else if(element.status=="cancelled" ) { %>
                                    <p>Cancelled on: <%= new Date(element.cancellationDate).toLocaleDateString() %></p>
                                <% } %>
                            </div>
                                <% if(element.status=="delivered" ) { %>
                                <!-- <div class="action_btn">Delivered</div> -->
                                <% } else if (element.status!="cancelled" ) { %>
                                    <div>
                                        <button class="action_btn" style="background-color: grey;"
                                            onclick="trackOrder('<%= element.order_id %>')">TrackOrder</button>
                                        <button class="action_btn" id="btn-<%= element.order_id %>"
                                            onclick='cancelOrder("<%= element.order_id %>","<%= element.order_quantity %>")'
                                            style="background-color: rgb(22, 22, 22);">Cancel</button>
                                    </div>
                                <% } %>
                        </div>
                    </div>
                    <% }) %>
                <% } else { %>
                    <h1>No orders has placed yet!</h1>
                <% } %>
        </div>
</body>
<script>
    const cancel_button = document.getElementById("cancelBtn");
    const reasonWindow = document.getElementById("reason");
    const trackingWindow = document.getElementById("trackingStatus")
    const trackingStatusBox = document.getElementById("trackingStatusPopUp")
    const allOrders = document.getElementById("orders");
    const reason = document.getElementById("reasontext");
    const reasonErr = document.getElementById("reason_err");

    reasonWindow.addEventListener('click', e => {
        reasonWindow.style.display = "none"
    })
    trackingWindow.addEventListener('click', e => {
        trackingWindow.style.display = "none"
        trackingStatusBox.innerHTML = `<h2 onclick="closeTrackingWindow()" style="position: absolute; top: 5px; right: 10px;">&times;</h2>`
    })
    trackingStatusBox.addEventListener('click', e => {
        e.stopPropagation()
    })
    reason.addEventListener('click', e => {
        e.stopPropagation()
    })
    reason.addEventListener('keyup', e => {
        if (reason.value.trim().length < 10) {
            reasonErr.innerText = "Reason must be specified";
        } else {
            reasonErr.innerText = "";
        }

    })

    function closeTrackingWindow() {
        trackingWindow.style.display = "none"
        trackingStatusBox.innerHTML = `<h2 onclick="closeTrackingWindow()" style="position: absolute; top: 5px; right: 10px;">&times;</h2>`
    }

    function trackOrder(id) {
        trackingWindow.style.display = "flex"
        fetch("/track/" + id)
            .then((result) => {
                return result.json()
            })
            .then(res => {
                const divCircle = document.createElement("div")
                divCircle.className = "track-circle-div"
                // if (res.length <= 0) {
                //     trackingStatusBox.appendChild(createTrackingElement("Waiting for confirmation and dispatch"))
                // }
                // if (res[0].dispatch_date) {
                //     trackingStatusBox.appendChild(createTrackingElement("Dispatched from seller on: " + new Date(res[0].dispatch_date).toLocaleDateString()))
                // }
                // if (res[0].S1receive_date) {
                //     trackingStatusBox.appendChild(createTrackingElement("Recived at: " + res[0].center1))
                //     trackingStatusBox.appendChild(createTrackingElement("Recived on: " + new Date(res[0].S1receive_date).toLocaleDateString()))
                // }
                // if (res[0].S2receive_date) {
                //     trackingStatusBox.appendChild(createTrackingElement("Received at: " + res[0].center2))
                //     trackingStatusBox.appendChild(createTrackingElement("Received on: " + new Date(res[0].S2receive_date).toLocaleDateString()))
                // }
                // if (res[0].deliveryPerson_id && res[0].status != "delivered") {
                //     // trackingStatusBox.appendChild(divCircle)
                //     trackingStatusBox.appendChild(createTrackingElement("Arriving Today"))
                //     trackingStatusBox.appendChild(createTrackingElement("Delivery Partner Name : " + res[0].deliveryPartnerName))
                //     trackingStatusBox.appendChild(createTrackingElement("Delivery Partner Mobile : " + res[0].deliveryPartnerMobile))
                // }
            })
            .catch((err) => {

            });
    }

    function createTrackingElement(t) {
        const h = document.createElement("h3")
        h.className = "tracking-headings"
        h.innerText = t
        return h
    }

    function cancelOrder(id, quantity) {
        reasonWindow.style.display = "flex"
        cancel_button.addEventListener('click', e => {
            if (reason.value.trim().length < 10) {
                alert("A reason must to given before cancelling the item.");
                return false;
            }
            console.log(id);
            fetch("/myorders/" + id,
                {
                    method: "POST",
                    headers: {
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({ "reason": reason.value, "quantity": quantity })
                })
                .then((result) => {
                    console.log(result);
                    if (result.ok) {
                        reason.value = ""
                        alert("Order Cancelled successfully !");
                        reasonWindow.style.display = "none";
                        document.getElementById("exp-del-" + id).innerText = "Cancelled on: " + new Date().toLocaleDateString();
                        document.getElementById("ord-sts-" + id).innerText = "Order Status: cancelled";
                        const btn = document.getElementById(`btn-${id}`);
                        btn.remove();
                    } else {
                        alert("Order Not Found !");
                    }
                }).catch((err) => {
                    alert("Something went wrong !");
                    console.log(err);
                });
        })
    }
</script>

</html>