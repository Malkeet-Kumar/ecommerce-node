<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="\stylesheets\dashboardHeader.css">
    <style>
        *{
            box-sizing: border-box;
        }
        .container{
            padding-top: 10px;
            display: flex;
            flex-direction: column;
            /* justify-content: center; */
            align-items: center;
        }
        .orderItem{
            width: 80%;
            height: 200px;
            border-radius: 10px;
            display: flex;
            justify-content: flex-start;
            box-shadow: 1px 1px 4px grey;
            margin: 10px;
        }
        .p_image{
            border-radius: 10px 0px 0px 10px;
            width: 20%;
        }
        .order_details{
            height: 100%;
            width: 50%;
            display: flex;
            flex-direction: column;
            padding: 10px;
            align-items: center;
        }
        .shipping_address{
            width: 100%;
            height: 20%;
        }
        .payment_status, .bill, .quantity, .product_id{
            padding: 2px;
            height: 20%;
            width: 100%;
        }
        .actions{
            height: 100%;
            width: 30%;
            border-radius: 0px 10px 10px 0px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
        }
        .order_id{
            width: 100%;
            word-wrap: break-word;
            padding: 10px;
        }
        .action_btn{
            align-self: flex-end;
            background-color: green;
            color: white;
            font-size: 17px;
            font-weight: bold;
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            margin-bottom: 20px;
            margin-right: 30px;
        }
        .form{
            position: fixed;
            top: 150px;
            height: 300px;
            width: 500px;
            box-shadow: 1px 1px 4px black;
            justify-self:flex-start;
            z-index: 10;
            background-color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
    </style>
</head>
<body>
    <%- include('components/header') %>
    <div class="container" id="reason" style="display:none; height:100vh; background-color:rgba(0, 0, 0, 0.274); width: 100%; position: fixed;">
        <div class="form">
            <label for="" style="margin-bottom: 10px;">Tell us why are you cancelling:</label>
            <textarea name="reason" id="reasontext" cols="30" rows="10"></textarea>
            <p style="color: red;" id="reason_err"></p>
            <button id="cancelBtn" class="action_btn" style="margin: 20px; align-self: center;">Cancel Order</button>
        </div>
    </div>
    <div class="container" id="orders">
        <% if(orders.length>0){ %>
            <% orders.forEach(element => { %>
                <div class="orderItem" id="orderItem-<%= element.order_id %>">
                    <img src="<%= !element.image.includes(".")?"/"+element.image:element.image %>" alt="" class="p_image">
                    <div class="order_details">
                        <div class="product_id">Product Name: <%= element.name %></div>
                        <div class="shipping_address">Shipping Address: <%= element.shipping_address %></div>
                        <div class="payment_status">Payment mode: <%= element.payment_mode %></div>
                        <div class="bill">Total Bill: <%= element.bill %> $</div>
                        <div class="quantity">Quantity: <%= element.order_quantity %></div>
                        <div class="quantity">Payment Status: <%= element.payment_status %></div>
                    </div>
                    <div class="actions">
                        <div class="order_id">
                            <p>OrderId:</p>
                            <p> <%= element.order_id %></p>
                            <br>
                            <p id="ord-sts-<%= element.order_id %>">Order Status: <span id="ps-<%= element.order_id %>"><%= element.status %></span></p>
                            <br>
                            <% if(element.status == "delivered") { %>
                                <p>Delivered on: <% element.delDate %></p>
                            <% } else if (element.status!="cancelled") { %>
                                <p id="exp-del-<%= element.order_id %>">Expected Delivery: <%= new Date(element.delivery_date).toLocaleDateString() %></p>
                            <% } else if(element.status=="cancelled")  { %>
                                <p>Cancelled on: <%= new Date(element.cancellationDate).toLocaleDateString() %></p>
                            <% } %>
                        </div>
                        <% if(element.status == "delivered") { %>
                            <div class="action_btn" >Delivered</div>
                        <% } else if (element.status!="cancelled") { %>
                            <button class="action_btn" id="btn-<%= element.order_id %>" onclick='cancelOrder("<%= element.order_id %>","<%= element.order_quantity %>")' style="background-color: blue;">Cancel</button>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <h1>No orders has placed yet!</h1>
        <% } %>
    </div>
</body>
<script>
    const cancel_button = document.getElementById("cancelBtn");
    const reasonWindow = document.getElementById("reason");
    const allOrders = document.getElementById("orders");
    const reason = document.getElementById("reasontext");
    const reasonErr = document.getElementById("reason_err");
    reason.addEventListener('keyup',e=>{
        if(reason.value.trim().length<10){
            reasonErr.innerText = "Reason must be specified";
        } else {
            reasonErr.innerText = "";
        }

    })
    function cancelOrder(id,quantity){  
        reasonWindow.style.display = "flex"
        cancel_button.addEventListener('click',e=>{
            if(reason.value.trim().length<10){
                alert("A reason must to given before cancelling the item.");
                return false;
            }
            console.log(id);
            fetch("/myorders/"+id,
            {
                method:"POST",
                headers: {
                    'content-type':'application/json'
                },
                body: JSON.stringify({"reason": reason.value,"quantity":quantity})
            })
            .then((result) => {
                console.log(result);
                if(result.ok){
                    reason.value = ""
                    alert("Order Cancelled successfully !");
                    reasonWindow.style.display = "none";
                    document.getElementById("exp-del-"+id).innerText = "Cancelled on: "+new Date().toLocaleDateString();
                    document.getElementById("ord-sts-"+id).innerText = "Order Status: cancelled";
                    const btn = document.getElementById(`btn-${id}`);
                    btn.remove();
                } else{
                    alert("Order Not Found !");
                }
            }).catch((err) => {
                alert("Something went wrong !");
                console.log(err);
            });
        })
    }
</script>
</html>